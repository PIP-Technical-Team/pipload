---
title: "Writing Lineup Distributions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{write-lineups-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>", 
  warning  = FALSE, 
  message  = FALSE)
```

```{r setup}
devtools::load_all(".")
library(collapse)
library(pipdata)
library(joyn)
```

This vignette demonstrates how to estimate, manipulate, and save lineup distribution data for multiple country-years using the writing functions. This process involves estimating the reference year distributions and saving them to `.qs` files.

# Preparing data

Before we begin using the writing functions, we need to ensure that the necessary objects (`gls`, `df_refy`, `dl_aux`) are properly loaded. These objects are created using the following code chunk:

```{r, results='hide'}
dir <- "C:/Users/wb612474/OneDrive - WBG/pip_technical_work/pipload"
file_list <- list.files(path = fs::path(dir,
                                        "refy-objects"))
vapply(file_list, 
       FUN = \(x) {
         nm <- gsub("\\.qs$", "", x)
         obj <- qs::qread(file = fs::path(dir, 
                                          "refy-objects", 
                                          x))
         assign(x     = paste(nm), 
                value = obj, 
                envir = .GlobalEnv)
         invisible(TRUE)
       }, 
       FUN.VALUE = logical(1), 
       USE.NAMES = F)
```
With the objects loaded, we're ready to proceed.

# Estimating reference year distributions

The `get_refy_distributions()` function estimates the reference year distributions for a given country and reference year. It takes the input data (`df_refy`), the country code (`cntry_code`), and the reference year (`ref_year`) as parameters, along with the global list (`gls`). More technical detail on the extrapolations and interpolations can be found [here](https://datanalytics.worldbank.org/PIP-Methodology/lineupestimates.html). In short, it loads the relevant surveys -- two if interpolation, one if extrapolation -- and adjust the entire distribution using the national accounts growth, adjusting weights in order to scale the populations, and appending the surveys.

```{r}
# Estimate reference year distributions for South Africa in 2020
COL_2000_dist <- get_refy_distributions(df_refy    = df_refy, 
                                        cntry_code = "COL", 
                                        ref_year   = 2000, 
                                        gls        = gls) |> 
  head()
COL_2000_dist
```

This function generates a data frame that contains the lineup distribution for the specified country and year. It applies the necessary transformations and joins relevant data. It also creates a variety of attributes for the resulting data frame, including the distributional statistics, which are estimated using a helper function `get_dist_stats()`. The distribution statistics include the min, max, mean, median, gini, mld, and polarization measures. The full list of attributes can be seen below, and includes more information about the survey/s used to estimate the lineup distribution.

```{r}
attributes(COL_2000_dist)
```

# Writing lineup distribution files

The estimation functions are then used by the writing functions to create the lineup distributions and write them to an appropriate, specified location. The most important writing function is `write_multiple_refy_dist()`, which allows the user to specify all the country-years to estimate and write. It applies i) the estimation functions, ii) a function to add auxiliary data as attributes, iii) a function to save the individual country-year file to the location of your choosing. The specified path should be where you want the files to be saved. 

The `cntry_refy` argument is a list where each element is another list containing country_code scalar (e.g. "ZAF") and year vector (e.g.`c(2001, 2002, 2003)`). If there are four countries, the `length(cntry_refy) = 4`, one for each country with its year vector.

```{r, eval = FALSE}
write_multiple_refy_dist(df_refy     = df_refy,
                         cntry_refy  = list(list(country_code = "ZAF",
                                                 year         = 2000:2001),
                                            list(country_code = "COL",
                                                 year         = 2018)),
                         path        = Sys.getenv("PIP_LINEUPS_DIR"), 
                         gls         = gls,
                         dl_aux      = dl_aux)
```

The `write_multiple_refy_dist()` also makes use of the internal `add_aux_data_attr()` function, which uses `dl_aux` to find the auxiliary data for that specific country-year which was used to create the lineup distribution. It then adds this data as an attributes. These attributes can be seen below for Colombia 2018 (for more on how to load the attributes directly, see the loading lineups vignette). 

```{r}
load_aux_data(country_code = "COL", 
              year         = 2018)
```


## Write only one file

If you want to write only one file -- i.e. for only one country, for one year -- then you can use the `write_refy_dist()` function. The arguments are i) the output from `get_refy_distributions()`, which gives the country and year; ii) the path, giving the writing location. 

```{r, eval = FALSE}
get_refy_distributions(df_refy    = df_refy,
                       cntry_code = "COL", 
                       ref_year   = 2000, 
                       gls        = gls) |> 
  write_refy_dist(path = Sys.getenv("PIP_LINEUPS_DIR"))
```


